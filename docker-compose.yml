version: "3.8"
services:
  # 1. MySQL Database
  mysql-db:
    image: mysql:8.0
    container_name: edumatch-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: Duong18122005!
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./services/mysql-init/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro   # ← ĐÃ CHUẨN
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pDuong18122005!"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # 2. User Service
  user-service:
    container_name: edumatch-user-service
    build:
      context: ./services/user-service
      dockerfile: Dockerfile.user-service
    restart: always
    ports:
      - "8001:8001"
    expose:
      - "8001"
    environment:
      DATABASE_URL: "mysql://user:password@mysql-db:3306/edumathdb"
      PORT: 8001
      JWT_SECRET: supersecret123456
    depends_on:
      mysql-db:
        condition: service_healthy          # ← CHỜ init.sql CHẠY XONG HOÀN TOÀN
    command: >
      sh -c "
        echo 'Đang chờ MySQL khởi động và chạy init.sql (tạo 6 DB)...';
        sleep 25;   # ← đủ cho init.sql của bạn (1KB, chạy trong 3-5s)
        echo 'MySQL đã sẵn sàng 100%! Khởi động user-service...';
        node dist/index.js
      "

  # 3. Application Service
  application-service:
    container_name: edumatch-application-service
    build:
      context: ./services/application-service
      dockerfile: Dockerfile
    restart: always
    ports:
      - "4002:4002"
    environment:
      DATABASE_URL: "mysql://user:password@mysql-db:3306/edumatch_applications_db"
      PORT: 4002
      JWT_SECRET: supersecret123456
    depends_on:
      - mysql-db
    command: >
      sh -c "pnpm exec prisma db push --accept-data-loss &&
            node dist/index.js"


  # 4. Opportunity Service
  opportunity-service:
    container_name: edumatch-opportunity
    build:
      context: ./services/opportunity-service
      dockerfile: Dockerfile
    restart: always
    environment:
      DATABASE_URL: "mysql://user:password@mysql-db:3306/edumatch_users_db"
      JWT_SECRET: supersecret123456
      PORT: 3000
    ports:
      - "8082:3000"
    depends_on:
      - mysql-db
    command: >
      sh -c "pnpm exec prisma db push --accept-data-loss &&
             node dist/index.js"

  # 5. Matching Service (Python)
  matching-service:
    container_name: edumatch-matching
    build:
      context: ./services/matching-service/app
      dockerfile: Dockerfile
    restart: always
    environment:
      MYSQL_HOST: mysql-db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DB: edumatch_users_db
      MYSQL_PORT: 3306
      USER_SERVICE_URL: http://user-service:8001
      OPPORTUNITY_SERVICE_URL: http://opportunity-service:3000
      APPLICATION_SERVICE_URL: http://application-service:4002
      STUDENT_PROFILE_URL: http://studentprofile-service:8005
      PORT: 8080
    ports:
      - "8080:8080"
    depends_on:
      - mysql-db
      - user-service
      - application-service
      - opportunity-service
      - studentprofile-service

  # 6. API Gateway
  api-gateway:
    image: nginx:alpine
    container_name: edumatch-gateway
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./fe:/usr/share/nginx/html:ro
      - ./services/api-gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - user-service
      - application-service
      - opportunity-service
      - matching-service


  # 7. Frontend React
  #web-react:
    #build:
      #dockerfile: Dockerfile
    ####- api-gateway

  # 8. Notification Service
  notification-service:
    container_name: edumatch-notification-service
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8083:8090"
    environment:
      - PORT=8090

  # 9. Student Profile Service
  studentprofile-service:
    container_name: edumatch-studentprofile
    build:
      context: ./services/studentprofile-service
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8005:8005"
    environment:
      # Kết nối vào DB riêng: edumatch_student_db
      # URL chuẩn cho SQLAlchemy: mysql+pymysql://user:password@host:port/dbname
      DATABASE_URL: mysql+pymysql://user:password@mysql-db:3306/edumatch_student_db
      MYSQL_HOST: mysql-db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DB: edumatch_student_db
      MYSQL_PORT: 3306
    depends_on:
      - mysql-db

  # 10. RabbitMQ Service (ĐÚNG VỊ TRÍ)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: edumatch-rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password

  # 11. Chat Service (ĐÚNG VỊ TRÍ)
  chat-service:
    container_name: edumatch-chat-service
    build:
      context: ./services/chat-service
      dockerfile: Dockerfile.chat-service
    restart: always
    environment:
      PORT: 5003
      DATABASE_URL: "mysql://root:Duong18122005%21@mysql-db:3306/edumatch_chat_db"
      RABBITMQ_URL: "amqp://rabbitmq"
    depends_on:
      - mysql-db
      - rabbitmq
    ports:
      - "5003:5003"

      
  # 9. Admin Service (Node.js)
  admin-service:
    container_name: edumatch-admin
    build:
      context: ./services/admin-service
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8006:8006" # Cổng 8006
    environment:
      # Kết nối CSDL Admin riêng (đã tạo trong init.sql)
      DATABASE_URL: "mysql://user:password@mysql-db:3306/edumatch_admin_db"
      PORT: 8006
      # JWT Secret phải giống hệt các service khác để verify token
      JWT_SECRET: supersecret123456
      # URL để gọi sang các service khác (Aggregator Pattern)
      USER_SERVICE_URL: http://user-service:8001
      OPP_SERVICE_URL: http://opportunity-service:3000
      APP_SERVICE_URL: http://application-service:4002
    depends_on:
      - mysql-db
      - user-service
      - opportunity-service
      - application-service
    # Tự động tạo bảng cho admin log khi khởi động
    command: >
      sh -c "pnpm exec prisma db push --accept-data-loss &&
             node dist/index.js"
volumes:
  mysql-data:
